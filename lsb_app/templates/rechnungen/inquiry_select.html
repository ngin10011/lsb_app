{# lsb_app/templates/rechnungen/inquiry_select.html #}
{% extends "base.html" %}

{% block title %}Anfragen an Bestattungsinstitute{% endblock %}

{% block body %}
<div class="container py-4">

  <h1 class="h4 mb-3">Anfragen an Bestattungsinstitute</h1>
  <p class="text-muted mb-4">
    Wählen Sie für jedes Bestattungsinstitut die Patient:innen aus, 
    für die Sie anfragen möchten, ob das Institut beauftragt wurde. 
    Pro Institut können Sie eine Sammel-Anfrage versenden.
  </p>

  {% if not auftraege %}
    <div class="alert alert-info">
      Es sind derzeit keine Aufträge im Status <strong>INQUIRY</strong> vorhanden.
    </div>
  {% else %}

    {# Gruppierung nach Bestattungsinstitut über Jinja groupby #}
    {% for group in auftraege|groupby('bestattungsinstitut_id') %}
        {% set inst_auftraege = group.list %}
        {% set institut = inst_auftraege[0].bestattungsinstitut %}

        <div class="card mb-4 shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <div class="fw-semibold">
                {{ institut.kurzbezeichnung or institut.firmenname or 'Unbenanntes Bestattungsinstitut' }}
                </div>
                {% if institut.adresse %}
                <div class="small text-muted">
                    {{ institut.adresse.strasse }} {{ institut.adresse.hausnummer }},
                    {{ institut.adresse.plz }} {{ institut.adresse.ort }}
                </div>
                {% endif %}
            </div>
            <div class="text-end">
                {% if institut.email %}
                <span class="badge text-bg-success">
                    {{ institut.email }}
                </span>
                {% else %}
                <span class="badge text-bg-warning text-dark">
                    keine E-Mail hinterlegt
                </span>
                {% endif %}
            </div>
            </div>

            <form method="post" action="{{ url_for('rechnungen.send_inquiry') }}">
            {{ form.hidden_tag() }}
            <input type="hidden" name="bestattungsinstitut_id" value="{{ institut.id }}">

          <div class="card-body p-0">
            <table class="table table-sm mb-0 align-middle">
              <thead>
                <tr>
                  <th style="width: 2.5rem;">
                    <div class="form-check mb-0">
                      <input class="form-check-input"
                             type="checkbox"
                             id="select-all-{{ institut.id }}"
                             onclick="toggleInquiryGroup('{{ institut.id }}')">
                    </div>
                  </th>
                  <th>Patient</th>
                  <th>Auftragsdatum</th>
                  <th>Auftragsnummer</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                {% for a in inst_auftraege %}
                  <tr>
                    <td>
                      <div class="form-check mb-0">
                        <input class="form-check-input"
                               type="checkbox"
                               name="auftrag_ids"
                               value="{{ a.id }}"
                               data-inquiry-group="{{ institut.id }}">
                      </div>
                    </td>
                    <td>
                      {{ a.patient.name }}, {{ a.patient.vorname }}
                    </td>
                    <td>
                      {{ a.auftragsdatum.strftime('%d.%m.%Y') if a.auftragsdatum else '—' }}
                    </td>
                    <td>
                      {{ a.auftragsnummer or a.id }}
                    </td>
                    <td>
                      {{ a.status.value if a.status else '—' }}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <div class="card-footer d-flex justify-content-between align-items-center">
            <div class="small text-muted">
              <label for="select-all-{{ institut.id }}" class="mb-0">
                <span class="form-check-label">Alle für dieses Institut auswählen</span>
              </label>
            </div>

            <button type="submit"
                    class="btn btn-primary btn-sm"
                    {% if not institut.email %}disabled{% endif %}>
              Anfrage für dieses Institut senden
            </button>
          </div>
        </form>
      </div>

    {% endfor %}
  {% endif %}

</div>
      <a href="{{ url_for('home.index') }}" class="btn btn-outline-secondary mt-3">
        Zurück zur Startseite
      </a>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    function toggleInquiryGroup(groupId) {
      const master = document.getElementById('select-all-' + groupId);
      const checkboxes = document.querySelectorAll(
        'input[data-inquiry-group="' + groupId + '"]'
      );
      checkboxes.forEach(cb => cb.checked = master.checked);
    }
  </script>
{% endblock %}
