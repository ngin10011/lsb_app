{# lsb_app/templates/rechnungen/send_batch_select.html #}
{% extends "base.html" %}

{% block title %}Batch-Versand vorbereiten{% endblock %}

{% block body %}
<div class="container py-4">

  <h1 class="h4 mb-3">Batch-Versand vorbereiten</h1>

  {% if auftraege %}
    <p class="mb-3">
      Es wurden <strong>{{ auftraege|length }}</strong> Aufträge gefunden, die für den E-Mail-Versand READY sind.
      Alle sind vorausgewählt. Entfernen Sie die Häkchen bei Aufträgen, die Sie jetzt nicht versenden möchten.
    </p>

    <form method="post">
      {{ form.csrf_token }}
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th style="width: 2.5rem;">
              <input class="form-check-input" type="checkbox" id="check-all" checked>
            </th>
            <th>Auftrag</th>
            <th>Patient</th>
            <th>Auftragsdatum</th>
            <th>Kostenstelle</th>
          </tr>
        </thead>
        <tbody>
          {% for a in auftraege %}
          <tr>
            <td>
              <input
                class="form-check-input auftrag-checkbox"
                type="checkbox"
                name="auftrag_ids"
                value="{{ a.id }}"
                checked
              >
            </td>
            <td>
              <a href="{{ url_for('patients.detail', pid=a.patient.id) }}">
              {{ '{:04d}'.format(a.auftragsnummer) if a and a.auftragsnummer is not none else '—' }}
              </a>
            </td>
            <td>{{ a.patient.name }}, {{ a.patient.vorname }}</td>
            <td>{{ a.auftragsdatum.strftime('%d.%m.%Y') if a.auftragsdatum else '-' }}</td>
            <td>{{ a.kostenstelle.value if a.kostenstelle else '-' }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="d-flex justify-content-between mt-3">
        <a href="{{ url_for('home.index') }}" class="btn btn-outline-secondary">
          Abbrechen
        </a>
        <button type="submit" class="btn btn-primary">
          Ausgewählte Rechnungen jetzt versenden
        </button>
      </div>
    </form>

  {% else %}
    {% if not auftraege_pending %}
      <div class="alert alert-info">
        Es sind derzeit keine Aufträge im Status <strong>READY</strong> für den E-Mail-Versand vorhanden.
      </div>
      <a href="{{ url_for('home.index') }}" class="btn btn-outline-secondary mt-3">
        Zurück zur Startseite
      </a>
    {% endif %}
  {% endif %}


  {% if auftraege_pending %}
    <hr class="my-4">

    <h2 class="h6 mb-2">Noch nicht fällige READY-Aufträge</h2>
    <p class="text-muted mb-3">
      Diese Aufträge haben eine zustellbare E-Mail-Adresse, sind aber noch keine 3 Tage alt.
    </p>

    <table class="table table-sm align-middle">
      <thead>
        <tr>
          <th class="text-end">Aktionen</th>
          <th>Auftrag</th>
          <th>Patient</th>
          <th>Auftragsdatum</th>
          <th>Versand ab</th>
          <th>Status Frist</th>
          <th>Kostenstelle</th>
        </tr>
      </thead>
      <tbody>
        {% for a in auftraege_pending %}
          {% if a.auftragsdatum %}
            {% set ready_date = a.auftragsdatum + timedelta(days=3) %}
            {% set diff_days = (ready_date - today).days %}
          {% else %}
            {% set ready_date = none %}
            {% set diff_days = none %}
          {% endif %}

          <tr>
            <td class="text-end">
              <a class="btn btn-sm btn-outline-secondary"
                href="{{ url_for('patients.detail', pid=a.patient.id) }}">
                Details
              </a>
            </td>
            <td>{{ a.auftragsnummer or a.id }}</td>
            <td>{{ a.patient.name }}, {{ a.patient.vorname }}</td>
            <td>{{ a.auftragsdatum.strftime('%d.%m.%Y') if a.auftragsdatum else '-' }}</td>
            <td>{{ ready_date.strftime('%d.%m.%Y') if ready_date else '-' }}</td>
            <td>
              {% if diff_days is none %}
                <span class="text-muted">—</span>
              {% elif diff_days == 0 %}
                Fällig heute
              {% else %}
                Noch {{ diff_days }} Tag{% if diff_days != 1 %}e{% endif %}
              {% endif %}
            </td>
            <td>{{ a.kostenstelle.value if a.kostenstelle else '-' }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

</div>

{% if auftraege %}
<script>
  const checkAll = document.getElementById('check-all');
  const checkboxes = document.querySelectorAll('.auftrag-checkbox');

  if (checkAll) {
    checkAll.addEventListener('change', function () {
      checkboxes.forEach(cb => cb.checked = checkAll.checked);
    });
  }
</script>
{% endif %}
{% endblock %}
