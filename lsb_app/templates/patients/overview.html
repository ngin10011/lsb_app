<!-- lsb_app/templates/patients/overview.html -->
{% extends "base.html" %}

{% block title %}Patientenübersicht{% endblock %}

{% block body %}
<h1 class="h4 mb-4">Patientenübersicht</h1>

{% macro addr(a) -%}
  {%- if a -%}{{ a.strasse }} {{ a.hausnummer }}, {{ a.plz }} {{ a.ort }}{%- else -%}—{%- endif -%}
{%- endmacro %}

<form method="get" class="row g-2 align-items-end mb-3">
  <div class="col-auto">
    <label class="form-label mb-1">Status</label>
    <select name="status" class="form-select form-select-sm">
      {% for val,label in status_choices %}
        <option value="{{ val }}" {{ 'selected' if val == selected_status else '' }}>{{ label }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-auto">
    <label class="form-label mb-1">Sortieren nach</label>
    <select name="sort" class="form-select form-select-sm">
      <option value="auftragsnummer" {{ 'selected' if sort=='auftragsnummer' else '' }}>Auftragsnummer</option>
      <option value="name" {{ 'selected' if sort=='name' else '' }}>Nachname</option>
      <option value="status" {{ 'selected' if sort=='status' else '' }}>Status</option>
    </select>
  </div>

  <div class="col-auto">
    <label class="form-label mb-1">Richtung</label>
    <select name="dir" class="form-select form-select-sm">
      <option value="asc"  {{ 'selected' if dir=='asc' else '' }}>aufsteigend</option>
      <option value="desc" {{ 'selected' if dir=='desc' else '' }}>absteigend</option>
    </select>
  </div>

  <div class="col-auto">
    <button type="submit" class="btn btn-sm btn-primary">Anwenden</button>
    <a href="{{ url_for('patients.overview') }}" class="btn btn-sm btn-outline-secondary">Zurücksetzen</a>
  </div>
</form>


<div class="table-responsive">
  <table class="table table-sm table-striped align-middle">
    {% set next_dir = 'desc' if dir=='asc' else 'asc' %}
    <thead class="table-light">
      <tr>
        <th>
          <a href="{{ url_for('patients.overview',
                              status=selected_status,
                              sort='auftragsnummer',
                              dir=(next_dir if sort=='auftragsnummer' else 'asc')) }}">
            Auftrag#
          </a>
        </th>
        <th>
          <a href="{{ url_for('patients.overview',
                              status=selected_status,
                              sort='name',
                              dir=(next_dir if sort=='name' else 'asc')) }}">
            Name
          </a>
        </th>
        <th>Vorname</th>
        <th>Geburtsdatum</th>
        <th>Auftragsadresse</th>
        <th>Auftragsdatum</th>
        <th>
          <a href="{{ url_for('patients.overview',
                              status=selected_status,
                              sort='status',
                              dir=(next_dir if sort=='status' else 'asc')) }}">
            Status
          </a>
        </th>
        <th>Kostenstelle</th>
        <th>Angehörige</th>
        <th>Bestattungsinstitut</th>
        <th>Behörden</th>
      </tr>
    </thead>

    <tbody>
      {% for p in patients %}
      {% set a = p.auftrag %}
      <tr>
        <td>
          <a href="{{ url_for('patients.detail', pid=p.id) }}">
          {{ '{:04d}'.format(a.auftragsnummer) if a and a.auftragsnummer is not none else '—' }}
          </a>
        </td>

        <td>{{ p.name }}</td>
        <td>{{ p.vorname }}</td>
        <td>{{ p.geburtsdatum.strftime('%d.%m.%Y') if p.geburtsdatum else '—' }}</td>

        <td>{{ addr(a.auftragsadresse) if a and a.auftragsadresse else '—' }}</td>
        <td>{{ a.auftragsdatum.strftime('%d.%m.%Y') if a and a.auftragsdatum else '—' }}</td>

        <td>{{ a.status.value if a and a.status else '—' }}</td>
        <td>{{ a.kostenstelle.value if a and a.kostenstelle else '—' }}</td>

        <td>
          {% if p.angehoerige %}
            {{ p.angehoerige | map(attribute='id') | list | join(', ') }}
          {% else %}—
          {% endif %}
        </td>

        <td>
          {% if a and a.bestattungsinstitut %}
            {{ a.bestattungsinstitut.kurzbezeichnung }}
          {% else %}—
          {% endif %}
        </td>

        <td>
          {% if a and a.behoerden %}
            {{ a.behoerden | map(attribute='name') | list | join(', ') }}
          {% else %}—
          {% endif %}
        </td>

      </tr>
      {% endfor %}
    </tbody>

  </table>
</div>

<div class="mt-4">
  <a href="{{ url_for('tb.new') }}"
     class="btn btn-success btn-sm">Neue Todesbescheinigung</a>
</div>

{% endblock %}
