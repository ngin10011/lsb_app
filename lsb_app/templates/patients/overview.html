<!-- lsb_app/templates/patients/overview.html -->
{% extends "base.html" %}

{% block title %}Patientenübersicht{% endblock %}

{% block body %}
<h1 class="h4 mb-4">Patientenübersicht</h1>

{% macro addr(a) -%}
  {%- if a -%}{{ a.strasse }} {{ a.hausnummer }}, {{ a.plz }} {{ a.ort }}{%- else -%}—{%- endif -%}
{%- endmacro %}

<div class="table-responsive">
  <table class="table table-sm table-striped align-middle">
    <thead class="table-light">
      <tr>
        <th>Name</th>
        <th>Vorname</th>
        <th>Geburtsdatum</th>
        <th>Auftragsadresse</th>
        <th>Auftragsdatum</th>
        <th>Status</th>
        <th>Kostenstelle</th>
        <th>Angehörige</th>
        <th>Bestattungsinstitut</th>
        <th>Behörden</th>
        <th></th>
      </tr>
    </thead>

    <tbody>
      {% for p in patients %}
      {% set a = p.auftrag %}
      <tr>
        <td>{{ p.name }}</td>
        <td>{{ p.vorname }}</td>
        <td>{{ p.geburtsdatum.strftime('%d.%m.%Y') if p.geburtsdatum else '—' }}</td>

        <td>{{ addr(a.auftragsadresse) if a and a.auftragsadresse else '—' }}</td>
        <td>{{ a.auftragsdatum.strftime('%d.%m.%Y') if a and a.auftragsdatum else '—' }}</td>

        <td>{{ a.status.value if a and a.status else '—' }}</td>
        <td>{{ a.kostenstelle.value if a and a.kostenstelle else '—' }}</td>

        <td>
          {% if p.angehoerige %}
            {{ p.angehoerige | map(attribute='id') | list | join(', ') }}
          {% else %}—
          {% endif %}
        </td>

        <td>
          {% if a and a.bestattungsinstitut %}
            {{ a.bestattungsinstitut.kurzbezeichnung }}
          {% else %}—
          {% endif %}
        </td>

        <td>
          {% if a and a.behoerden %}
            {{ a.behoerden | map(attribute='name') | list | join(', ') }}
          {% else %}—
          {% endif %}
        </td>

        <td class="text-end">
          <a href="{{ url_for('patients.detail', pid=p.id) }}"
             class="btn btn-sm btn-primary">
            Details
          </a>
        </td>
      </tr>
      {% endfor %}
    </tbody>

  </table>
</div>

<div class="mt-4">
  <a href="{{ url_for('tb.new') }}"
     class="btn btn-success btn-sm">Neue Todesbescheinigung</a>
</div>

{% endblock %}
