<!-- lsb_app/templates/auftraege/edit.html -->
{% extends "base.html" %}
{% block title %}Auftrag bearbeiten{% endblock %}

{% block body %}
<h1 class="h5 mb-3">
  Auftrag bearbeiten
  <small class="text-muted">(#{{ auftrag.id }})</small>
</h1>

<form method="post">
  {{ form.csrf_token }}
  <div class="row g-3">
    <div class="col-md-3">
      <label class="form-label">{{ form.auftragsnummer.label }}</label>
      {{ form.auftragsnummer(class="form-control") }}
      {% for e in form.auftragsnummer.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    </div>
    <div class="col-md-3">
      <label class="form-label">{{ form.auftragsdatum.label }}</label>
      {{ form.auftragsdatum(class="form-control", placeholder="YYYY-MM-DD") }}
      {% for e in form.auftragsdatum.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    </div>
    <div class="col-md-3">
      <label class="form-label">{{ form.auftragsuhrzeit.label }}</label>
      {{ form.auftragsuhrzeit(class="form-control", placeholder="HH:MM") }}
      {% for e in form.auftragsuhrzeit.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    </div>
    <div class="col-md-3">
      <label class="form-label">{{ form.mehraufwand.label }}</label><br>
      {{ form.mehraufwand(class="form-check-input") }}
      {% for e in form.mehraufwand.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    </div>

    <div class="col-md-4">
      <label class="form-label">{{ form.kostenstelle.label }}</label>
      {{ form.kostenstelle(class="form-select") }}
      {% for e in form.kostenstelle.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    </div>
    <div class="col-md-4">
      <label class="form-label">{{ form.status.label }}</label>
      {{ form.status(class="form-select") }}
      {% for e in form.status.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    </div>
    <div class="col-md-4 d-none" id="wait-due-date-wrapper">
      <label class="form-label">{{ form.wait_due_date.label }}</label>
      {{ form.wait_due_date(class="form-control", placeholder="YYYY-MM-DD") }}
      {% for e in form.wait_due_date.errors %}
        <div class="text-danger small">{{ e }}</div>
      {% endfor %}
    </div>

    <div class="col-12">
      <label class="form-label">{{ form.bemerkung.label }}</label>
      {{ form.bemerkung(class="form-control", rows="3") }}
      {% for e in form.bemerkung.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    </div>
  </div>

    <div class="col-md-6">
      {{ form.auftragsadresse_id.label(class="form-label") }}
      <div class="d-flex gap-2">
        {{ form.auftragsadresse_id(class="form-select") }}
        {% if auftrag.auftragsadresse %}
          <a class="btn btn-outline-secondary"
             href="{{ url_for('addresses.edit', aid=auftrag.auftragsadresse.id, next=request.full_path) }}">
            Adresse Ã¤ndern
          </a>
        {% endif %}
      </div>
      {% for e in form.auftragsadresse_id.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
    </div>

  <div class="mt-4 d-flex gap-2">
    <a href="{{ request.args.get('next') or url_for('patients.detail', pid=auftrag.patient_id) }}" class="btn btn-outline-secondary">
      Abbrechen
    </a>
    {{ form.submit(class="btn btn-primary") }}
  </div>
</form>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const statusSelect = document.querySelector('select[name="status"]');
    const waitWrapper = document.getElementById("wait-due-date-wrapper");

    if (!statusSelect || !waitWrapper) return;

    function toggleWaitDate() {
      if (statusSelect.value === "WAIT") {
        waitWrapper.classList.remove("d-none");
      } else {
        waitWrapper.classList.add("d-none");
        const input = waitWrapper.querySelector("input");
        if (input) input.value = "";
      }
    }

    // Initialzustand (wichtig beim Bearbeiten!)
    toggleWaitDate();

    statusSelect.addEventListener("change", toggleWaitDate);
  });
</script>
{% endblock %}
