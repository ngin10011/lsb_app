{# lsb_app/templates/auftraege/wait.html #}
{% extends "base.html" %}

{% block title %}WAIT-Übersicht{% endblock %}

{% block body %}
<div class="container py-4">

  <h1 class="h4 mb-3">Aufträge im Status WAIT</h1>

  <p class="text-muted mb-4">
    WAIT bedeutet, dass für den Auftrag auf weitere Informationen oder Rückmeldungen gewartet wird.
    Unten sehen Sie getrennt:
    <br>
    – Aufträge mit gestellter Anfrage an das Bestattungsinstitut<br>
    – sonstige WAIT-Aufträge (z.&nbsp;B. fehlende Angaben von Angehörigen)
  </p>

  {# --- Bereich 1: BI-Anfragen mit is_inquired = True --- #}
  <h2 class="h6 mt-3 mb-2">Rückmeldungen von Bestattungsinstituten verarbeiten</h2>

  {% if not auftraege_inquired %}
    <div class="alert alert-info">
      Es sind derzeit keine WAIT-Aufträge mit gestellter Anfrage an ein Bestattungsinstitut vorhanden.
    </div>
  {% else %}

    <div class="d-flex justify-content-end mb-2">
      <div class="btn-group btn-group-sm" role="group">
        <a href="{{ url_for('auftraege.wait_list', sort='due_asc') }}"
           class="btn btn-outline-secondary {{ 'active' if sort == 'due_asc' else '' }}">
          Fälligkeit ↑
        </a>
        <a href="{{ url_for('auftraege.wait_list', sort='due_desc') }}"
           class="btn btn-outline-secondary {{ 'active' if sort == 'due_desc' else '' }}">
          Fälligkeit ↓
        </a>
        <a href="{{ url_for('auftraege.wait_list', sort='datum_asc') }}"
           class="btn btn-outline-secondary {{ 'active' if sort == 'datum_asc' else '' }}">
          Datum ↑
        </a>
        <a href="{{ url_for('auftraege.wait_list', sort='datum_desc') }}"
           class="btn btn-outline-secondary {{ 'active' if sort == 'datum_desc' else '' }}">
          Datum ↓
        </a>
      </div>
    </div>

    <form method="post">
      {{ form.csrf_token }}

      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th style="width: 2.5rem;">
              <input class="form-check-input" type="checkbox" id="check-all">
            </th>
            <th>Auftrag</th>
            <th>Patient</th>
            <th>Auftragsdatum</th>
            <th>Fällig am</th>
            <th>Status Frist</th>
            <th class="text-end">Aktionen</th>
          </tr>
        </thead>
        <tbody>
          {% for a in auftraege_inquired %}
            {% set due = a.wait_due_date %}
            {% set is_overdue = (due is not none and due < today) %}
            {% if is_overdue %}
              {% set diff_days = (today - due).days %}
            {% elif due is not none %}
              {% set diff_days = (due - today).days %}
            {% else %}
              {% set diff_days = none %}
            {% endif %}

            <tr class="{% if is_overdue %}table-warning{% endif %}">
              <td>
                <input
                  class="form-check-input auftrag-checkbox"
                  type="checkbox"
                  name="auftrag_ids"
                  value="{{ a.id }}"
                >
              </td>
              <td>{{ a.auftragsnummer or a.id }}</td>
              <td>{{ a.patient.name }}, {{ a.patient.vorname }}</td>
              <td>{{ a.auftragsdatum.strftime('%d.%m.%Y') if a.auftragsdatum else '—' }}</td>
              <td>{{ due.strftime('%d.%m.%Y') if due else '—' }}</td>
              <td>
                {% if due is none %}
                  <span class="text-muted">Keine Fälligkeit gesetzt</span>
                {% elif is_overdue %}
                  Überfällig seit {{ diff_days }} Tag{% if diff_days != 1 %}en{% endif %}
                {% elif diff_days == 0 %}
                  Fällig heute
                {% else %}
                  Noch {{ diff_days }} Tag{% if diff_days != 1 %}e{% endif %}
                {% endif %}
              </td>
              <td class="text-end">
                <div class="btn-group btn-group-sm" role="group">
                  <a href="{{ url_for('patients.detail', pid=a.patient.id) }}"
                     class="btn btn-outline-secondary">
                    Details
                  </a>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="d-flex justify-content-between mt-3 mb-4">
        <a href="{{ url_for('home.index') }}" class="btn btn-outline-secondary">
          Zurück zur Startseite
        </a>
        <button type="submit" class="btn btn-primary">
          Ausgewählte Aufträge auf READY setzen
        </button>
      </div>
    </form>

    <script>
      const checkAll = document.getElementById('check-all');
      const checkboxes = document.querySelectorAll('.auftrag-checkbox');

      if (checkAll) {
        checkAll.addEventListener('change', function () {
          checkboxes.forEach(cb => cb.checked = checkAll.checked);
        });
      }
    </script>

  {% endif %}

  {# --- Bereich 2: Sonstige WAIT-Aufträge --- #}
  <h2 class="h6 mt-4 mb-2">Sonstige WAIT-Aufträge</h2>

  {% if not auftraege_other %}
    <p class="text-muted">
      Es sind derzeit keine weiteren WAIT-Aufträge vorhanden.
    </p>
  {% else %}
    <table class="table table-sm align-middle">
      <thead>
        <tr>
          <th>Auftrag</th>
          <th>Patient</th>
          <th>Auftragsdatum</th>
          <th>Fällig am</th>
          <th class="text-end">Aktionen</th>
        </tr>
      </thead>
      <tbody>
        {% for a in auftraege_other %}
          <tr>
            <td>{{ a.auftragsnummer or a.id }}</td>
            <td>{{ a.patient.name }}, {{ a.patient.vorname }}</td>
            <td>{{ a.auftragsdatum.strftime('%d.%m.%Y') if a.auftragsdatum else '—' }}</td>
            <td>{{ a.wait_due_date.strftime('%d.%m.%Y') if a.wait_due_date else '—' }}</td>
            <td class="text-end">
              <a href="{{ url_for('patients.detail', pid=a.patient.id) }}"
                 class="btn btn-outline-secondary btn-sm">
                Details
              </a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}

</div>
{% endblock %}
